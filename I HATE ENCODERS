package org.firstinspires.ftc.teamcode;

import com.qualcomm.robotcore.eventloop.opmode.LinearOpMode;
import com.qualcomm.robotcore.eventloop.opmode.Autonomous;
import com.qualcomm.robotcore.hardware.DcMotor;
import com.qualcomm.robotcore.hardware.DcMotorSimple;
import com.qualcomm.robotcore.util.ElapsedTime;

@Autonomous(name="Red Encoder Far Auton (Optimized)", group="Linear OpMode")
public class RedEncoderFarAuton extends LinearOpMode {

    // === Drive Motors ===
    private DcMotor frontLeftMotor  = null;
    private DcMotor frontRightMotor = null;
    private DcMotor backLeftMotor   = null;
    private DcMotor backRightMotor  = null;
    private DcMotor intake1 = null;
    private DcMotor intake2 = null;
    private DcMotor flywheelLeft = null;
    private DcMotor flywheelRight = null;

    // === Encoder Constants ===
    public static final double COUNTS_PER_REV = 580.4;
    public static final double WHEEL_DIAMETER_INCHES = 3.78;
    public static final double WHEEL_CIRCUMFERENCE = Math.PI * WHEEL_DIAMETER_INCHES;
    public static final double TICKS_PER_INCH = COUNTS_PER_REV / WHEEL_CIRCUMFERENCE;

    @Override
    public void runOpMode() throws InterruptedException {

        // === Hardware Mapping ===
        frontLeftMotor  = hardwareMap.get(DcMotor.class, "port");
        frontRightMotor = hardwareMap.get(DcMotor.class, "port");
        backLeftMotor   = hardwareMap.get(DcMotor.class, "port");
        backRightMotor  = hardwareMap.get(DcMotor.class, "port");
        intake1 = hardwareMap.get(DcMotor.class, "port");
        intake2 = hardwareMap.get(DcMotor.class, "port");
        flywheelLeft = hardwareMap.get(DcMotor.class, "port");
        flywheelRight = hardwareMap.get(DcMotor.class, "port");

        // === Motor Directions ===
        frontRightMotor.setDirection(DcMotorSimple.Direction.REVERSE);
        backRightMotor.setDirection(DcMotorSimple.Direction.REVERSE);
        intake1.setDirection(DcMotorSimple.Direction.REVERSE);
        flywheelLeft.setDirection(DcMotorSimple.Direction.FORWARD);
        flywheelRight.setDirection(DcMotorSimple.Direction.REVERSE);

        // === Zero Power Behavior ===
        intake1.setZeroPowerBehavior(DcMotor.ZeroPowerBehavior.FLOAT);
        flywheelRight.setZeroPowerBehavior(DcMotor.ZeroPowerBehavior.BRAKE);
        flywheelLeft.setZeroPowerBehavior(DcMotor.ZeroPowerBehavior.BRAKE);
        frontLeftMotor.setZeroPowerBehavior(DcMotor.ZeroPowerBehavior.BRAKE);
        frontRightMotor.setZeroPowerBehavior(DcMotor.ZeroPowerBehavior.BRAKE);
        backLeftMotor.setZeroPowerBehavior(DcMotor.ZeroPowerBehavior.BRAKE);
        backRightMotor.setZeroPowerBehavior(DcMotor.ZeroPowerBehavior.BRAKE);

        // === Reset Encoders ===
        resetEncoders();

        telemetry.addLine("READY");
        telemetry.update();

        waitForStart();
        if (isStopRequested()) return;

        // === AUTON START ===

        shootBall();

        driveForDistance(32, 0.8);

        TurnForAngle(-25, 0.5);

        strafeForDistance(8, 0.5, true);

        intakeBall();

        strafeForDistance(24, 0.6, false);

        TurnForAngle(25, 0.5);

        shootBall();

        TurnForAngle(-25, 0.5);

        driveForDistance(60, 1.0);

        TurnForAngle(-90, 0.6);

        intakeBall();

        driveForDistance(48, 0.8);

        strafeForDistance(48,0.7, false);

        strafeForDistance(48,0.7, true);

        driveForDistance(50, 0.6);

        TurnForAngle(125, 0.6);

        shootBall();

        TurnForAngle(-35, 0.6);

        driveForDistance(-24, 0.7);

        TurnForAngle(-90, 0.6);

        intakeBall();

        driveForDistance(50, 0.9);

        TurnForAngle(90, 0.6);

        driveForDistance(-60, 1.0);

        TurnForAngle(25, 0.5);

        shootBall();

        TurnForAngle(-25, 0.5);

        driveForDistance(36, 0.7);

        TurnForAngle(-90, 0.7);

        intakeBall();

        driveForDistance(50, 1.0);

        TurnForAngle(125, 0.6);

        shootBall();

        TurnForAngle(-35, 0.6);

        TurnForAngle(-90, 0.6);

        intakeBall();

        driveForDistance(54, 0.6);

        TurnForAngle(125, 0.6);

        shootBall();

        TurnForAngle(-125, 0.6);

        intakeBall();

        driveForDistance(54, 0.6);

        TurnForAngle(125, 0.6);

        shootBall();

        TurnForAngle(-35, 0.7);

        driveForDistance(36, 0.7);

        stopMotors();
    }

    // === Reset Encoders ===
    private void resetEncoders() {
        frontLeftMotor.setMode(DcMotor.RunMode.STOP_AND_RESET_ENCODER);
        frontRightMotor.setMode(DcMotor.RunMode.STOP_AND_RESET_ENCODER);
        backLeftMotor.setMode(DcMotor.RunMode.STOP_AND_RESET_ENCODER);
        backRightMotor.setMode(DcMotor.RunMode.STOP_AND_RESET_ENCODER);

        frontLeftMotor.setMode(DcMotor.RunMode.RUN_USING_ENCODER);
        frontRightMotor.setMode(DcMotor.RunMode.RUN_USING_ENCODER);
        backLeftMotor.setMode(DcMotor.RunMode.RUN_USING_ENCODER);
        backRightMotor.setMode(DcMotor.RunMode.RUN_USING_ENCODER);
    }

    // === Faster Shoot Cycle ===
    public void shootBall() {
        ElapsedTime t = new ElapsedTime();

        // Flywheel spinup (shortened)
        flywheelLeft.setPower(-1);
        flywheelRight.setPower(-1);
        while (opModeIsActive() && t.seconds() < 0.25) {}

        // Feed ball
        t.reset();
        intake1.setPower(-0.5);
        intake2.setPower(-0.5);
        while (opModeIsActive() && t.seconds() < 1.5) {}

        // Stop
        intake1.setPower(0);
        intake2.setPower(0);
        flywheelLeft.setPower(0);
        flywheelRight.setPower(0);
    }

    // === Intake (Option C timing) ===
    public void intakeBall() {
        ElapsedTime t = new ElapsedTime();

        // pre-delay 0.1s
        while (opModeIsActive() && t.seconds() < 0.1) {}

        // drive + intake
        t.reset();
        frontLeftMotor.setPower(-0.6);
        frontRightMotor.setPower(-0.6);
        backLeftMotor.setPower(-0.6);
        backRightMotor.setPower(-0.6);
        intake1.setPower(-0.4);
        intake2.setPower(-0.4);

        while (opModeIsActive() && t.seconds() < 1.0) {}

        // stop
        stopMotors();
        intake1.setPower(0);
        intake2.setPower(0);

        // post-delay 0.2s
        t.reset();
        while (opModeIsActive() && t.seconds() < 0.2) {}
    }

    // === Turning ===
    public void TurnForAngle(double angleDegrees, double power) {
        double TRACK_WIDTH = 21.3028;
        double turnInches = Math.PI * TRACK_WIDTH * (angleDegrees / 360.0);
        int ticks = (int)(turnInches * TICKS_PER_INCH);

        frontLeftMotor.setTargetPosition(frontLeftMotor.getCurrentPosition() + ticks);
        backLeftMotor.setTargetPosition(backLeftMotor.getCurrentPosition() + ticks);
        frontRightMotor.setTargetPosition(frontRightMotor.getCurrentPosition() - ticks);
        backRightMotor.setTargetPosition(backRightMotor.getCurrentPosition() - ticks);

        frontLeftMotor.setMode(DcMotor.RunMode.RUN_TO_POSITION);
        backLeftMotor.setMode(DcMotor.RunMode.RUN_TO_POSITION);
        frontRightMotor.setMode(DcMotor.RunMode.RUN_TO_POSITION);
        backRightMotor.setMode(DcMotor.RunMode.RUN_TO_POSITION);

        frontLeftMotor.setPower(power);
        backLeftMotor.setPower(power);
        frontRightMotor.setPower(power);
        backRightMotor.setPower(power);

        while (opModeIsActive() &&
                frontLeftMotor.isBusy() && frontRightMotor.isBusy() &&
                backLeftMotor.isBusy() && backRightMotor.isBusy()) {}

        stopMotors();
    }

    // === Driving ===
    public void driveForDistance(double distanceInches, double power) {
        int ticks = (int)(distanceInches * TICKS_PER_INCH);

        frontLeftMotor.setTargetPosition(frontLeftMotor.getCurrentPosition() + ticks);
        backLeftMotor.setTargetPosition(backLeftMotor.getCurrentPosition() + ticks);
        frontRightMotor.setTargetPosition(frontRightMotor.getCurrentPosition() + ticks);
        backRightMotor.setTargetPosition(backRightMotor.getCurrentPosition() + ticks);

        frontLeftMotor.setMode(DcMotor.RunMode.RUN_TO_POSITION);
        backLeftMotor.setMode(DcMotor.RunMode.RUN_TO_POSITION);
        frontRightMotor.setMode(DcMotor.RunMode.RUN_TO_POSITION);
        backRightMotor.setMode(DcMotor.RunMode.RUN_TO_POSITION);

        frontLeftMotor.setPower(power);
        backLeftMotor.setPower(power);
        frontRightMotor.setPower(power);
        backRightMotor.setPower(power);

        while (opModeIsActive() &&
                frontLeftMotor.isBusy() && frontRightMotor.isBusy() &&
                backLeftMotor.isBusy() && backRightMotor.isBusy()) {}

        stopMotors();
    }

    // === Strafing ===
    public void strafeForDistance(double distanceInches, double power, boolean right) {
        int ticks = (int)(distanceInches * TICKS_PER_INCH);

        if (right) {
            frontLeftMotor.setTargetPosition(frontLeftMotor.getCurrentPosition() + ticks);
            backLeftMotor.setTargetPosition(backLeftMotor.getCurrentPosition() - ticks);
            frontRightMotor.setTargetPosition(frontRightMotor.getCurrentPosition() - ticks);
            backRightMotor.setTargetPosition(backRightMotor.getCurrentPosition() + ticks);
        } else {
            frontLeftMotor.setTargetPosition(frontLeftMotor.getCurrentPosition() - ticks);
            backLeftMotor.setTargetPosition(backLeftMotor.getCurrentPosition() + ticks);
            frontRightMotor.setTargetPosition(frontRightMotor.getCurrentPosition() + ticks);
            backRightMotor.setTargetPosition(backRightMotor.getCurrentPosition() - ticks);
        }

        frontLeftMotor.setMode(DcMotor.RunMode.RUN_TO_POSITION);
        backLeftMotor.setMode(DcMotor.RunMode.RUN_TO_POSITION);
        frontRightMotor.setMode(DcMotor.RunMode.RUN_TO_POSITION);
        backRightMotor.setMode(DcMotor.RunMode.RUN_TO_POSITION);

        frontLeftMotor.setPower(power);
        backLeftMotor.setPower(power);
        frontRightMotor.setPower(power);
        backRightMotor.setPower(power);

        while (opModeIsActive() &&
                frontLeftMotor.isBusy() && frontRightMotor.isBusy() &&
                backLeftMotor.isBusy() && backRightMotor.isBusy()) {}

        stopMotors();
    }

    // === Stop All ===
    private void stopMotors() {
        frontLeftMotor.setPower(0);
        frontRightMotor.setPower(0);
        backLeftMotor.setPower(0);
        backRightMotor.setPower(0);

        frontLeftMotor.setMode(DcMotor.RunMode.RUN_USING_ENCODER);
        frontRightMotor.setMode(DcMotor.RunMode.RUN_USING_ENCODER);
        backLeftMotor.setMode(DcMotor.RunMode.RUN_USING_ENCODER);
        backRightMotor.setMode(DcMotor.RunMode.RUN_USING_ENCODER);
    }
}
