package org.firstinspires.ftc.teamcode;

import com.qualcomm.robotcore.eventloop.opmode.Autonomous;
import com.qualcomm.robotcore.eventloop.opmode.LinearOpMode;
import com.qualcomm.robotcore.hardware.DcMotor;
import com.qualcomm.robotcore.hardware.DcMotorSimple;
import com.qualcomm.robotcore.util.ElapsedTime;

@Autonomous(name="Blue Encoder Close Auton", group="Linear OpMode")
public class BlueEncoderCloseAuton extends LinearOpMode {

    // === Drive Motors ===
    private DcMotor frontLeftMotor  = null;
    private DcMotor frontRightMotor = null;
    private DcMotor backLeftMotor   = null;
    private DcMotor backRightMotor  = null;
    private DcMotor intake1 = null;
    private DcMotor intake2 = null;
    private DcMotor flywheelLeft = null;
    private DcMotor flywheelRight = null;

    // === Encoder Constants ===
    public static final double COUNTS_PER_REV = 580.4;
    public static final double WHEEL_DIAMETER_INCHES = 3.78;
    public static final double WHEEL_CIRCUMFERENCE = Math.PI * WHEEL_DIAMETER_INCHES;
    public static final double TICKS_PER_INCH = COUNTS_PER_REV / WHEEL_CIRCUMFERENCE;

    @Override
    public void runOpMode() throws InterruptedException {

        // === HARDWARE MAP (temporary placeholders) ===
        frontLeftMotor  = hardwareMap.get(DcMotor.class, "port");
        frontRightMotor = hardwareMap.get(DcMotor.class, "port");
        backLeftMotor   = hardwareMap.get(DcMotor.class, "port");
        backRightMotor  = hardwareMap.get(DcMotor.class, "port");
        intake1         = hardwareMap.get(DcMotor.class, "port");
        intake2         = hardwareMap.get(DcMotor.class, "port");
        flywheelLeft    = hardwareMap.get(DcMotor.class, "port");
        flywheelRight   = hardwareMap.get(DcMotor.class, "port");

        // === MOTOR DIRECTIONS ===
        frontRightMotor.setDirection(DcMotorSimple.Direction.REVERSE);
        backRightMotor.setDirection(DcMotorSimple.Direction.REVERSE);
        intake1.setDirection(DcMotorSimple.Direction.REVERSE);
        flywheelLeft.setDirection(DcMotorSimple.Direction.FORWARD);
        flywheelRight.setDirection(DcMotorSimple.Direction.REVERSE);

        // === ZERO POWER BEHAVIOR ===
        frontLeftMotor.setZeroPowerBehavior(DcMotor.ZeroPowerBehavior.BRAKE);
        frontRightMotor.setZeroPowerBehavior(DcMotor.ZeroPowerBehavior.BRAKE);
        backLeftMotor.setZeroPowerBehavior(DcMotor.ZeroPowerBehavior.BRAKE);
        backRightMotor.setZeroPowerBehavior(DcMotor.ZeroPowerBehavior.BRAKE);
        flywheelLeft.setZeroPowerBehavior(DcMotor.ZeroPowerBehavior.BRAKE);
        flywheelRight.setZeroPowerBehavior(DcMotor.ZeroPowerBehavior.BRAKE);
        intake1.setZeroPowerBehavior(DcMotor.ZeroPowerBehavior.FLOAT);

        // === RESET ENCODERS ===
        resetEncoders();

        telemetry.addLine("Initialized and Ready");
        telemetry.update();

        waitForStart();
        if (isStopRequested()) return;

        // === FULL AUTON SEQUENCE (EXACT ORDER PRESERVED) ===

        driveForDistance(-72, 0.8);

        shootBall();

        TurnForAngle(160, 0.7);

        intakeBall();

        driveForDistance(48, 1);

        TurnForAngle(-125, 0.6);

        shootBall();

        TurnForAngle(35, 0.6);

        driveForDistance(-6, 0.5);

        strafeForDistance(40, 0.8, true);

        strafeForDistance(40, 0.6, false);

        driveForDistance(-12, 0.6);

        TurnForAngle(-90, 0.7);

        intakeBall();

        driveForDistance(38, 1);

        TurnForAngle(125, 0.7);

        strafeForDistance(4, 0.5, true);

        shootBall();

        TurnForAngle(35, 0.6);

        driveForDistance(-48, 0.6);

        TurnForAngle(90, 0.6);

        intakeBall();

        driveForDistance(60, 0.7);

        TurnForAngle(-125, 0.6);

        shootBall();

        TurnForAngle(-125, 0.6);

        intakeBall();

        driveForDistance(60, 0.7);

        TurnForAngle(-45, 0.6);

        shootBall();

        TurnForAngle(45, 0.6);

        intakeBall();

        driveForDistance(60, 0.7);

        TurnForAngle(-45, 0.6);

        shootBall();

        driveForDistance(36, 0.8);

        stopMotors();
    }

    // === RESET ENCODERS ===
    private void resetEncoders() {
        frontLeftMotor.setMode(DcMotor.RunMode.STOP_AND_RESET_ENCODER);
        frontRightMotor.setMode(DcMotor.RunMode.STOP_AND_RESET_ENCODER);
        backLeftMotor.setMode(DcMotor.RunMode.STOP_AND_RESET_ENCODER);
        backRightMotor.setMode(DcMotor.RunMode.STOP_AND_RESET_ENCODER);

        frontLeftMotor.setMode(DcMotor.RunMode.RUN_USING_ENCODER);
        frontRightMotor.setMode(DcMotor.RunMode.RUN_USING_ENCODER);
        backLeftMotor.setMode(DcMotor.RunMode.RUN_USING_ENCODER);
        backRightMotor.setMode(DcMotor.RunMode.RUN_USING_ENCODER);
    }

    // === SHOOT BALL ===
    public void shootBall() {
        ElapsedTime timer = new ElapsedTime();

        timer.reset();
        while (opModeIsActive() && timer.seconds() < 1.0) {}

        flywheelLeft.setPower(-1);
        flywheelRight.setPower(-1);

        timer.reset();
        while (opModeIsActive() && timer.seconds() < 0.15) {}

        intake1.setPower(-0.5);
        intake2.setPower(-0.5);

        timer.reset();
        while (opModeIsActive() && timer.seconds() < 1.5) {}

        flywheelLeft.setPower(0);
        flywheelRight.setPower(0);
        intake1.setPower(0);
        intake2.setPower(0);

        timer.reset();
        while (opModeIsActive() && timer.seconds() < 0.5) {}
    }

    // === INTAKE BALL ===
    public void intakeBall() {
        ElapsedTime timer = new ElapsedTime();

        timer.reset();
        while (opModeIsActive() && timer.seconds() < 0.5) {}

        frontLeftMotor.setPower(-0.6);
        frontRightMotor.setPower(-0.6);
        backLeftMotor.setPower(-0.6);
        backRightMotor.setPower(-0.6);
        intake1.setPower(-0.4);
        intake2.setPower(-0.4);

        timer.reset();
        while (opModeIsActive() && timer.seconds() < 1.5) {}

        stopMotors();
        intake1.setPower(0);
        intake2.setPower(0);

        timer.reset();
        while (opModeIsActive() && timer.seconds() < 1.0) {}
    }

    // === TURN ===
    public void TurnForAngle(double angleDegrees, double power) {
        double TRACK_WIDTH = 21.3028;
        double ROBOT_CIRC = Math.PI * TRACK_WIDTH;

        double inches = ROBOT_CIRC * (angleDegrees / 360.0);
        int ticks = (int) (inches * TICKS_PER_INCH);

        frontLeftMotor.setTargetPosition(frontLeftMotor.getCurrentPosition() + ticks);
        backLeftMotor.setTargetPosition(backLeftMotor.getCurrentPosition() + ticks);
        frontRightMotor.setTargetPosition(frontRightMotor.getCurrentPosition() - ticks);
        backRightMotor.setTargetPosition(backRightMotor.getCurrentPosition() - ticks);

        frontLeftMotor.setMode(DcMotor.RunMode.RUN_TO_POSITION);
        backLeftMotor.setMode(DcMotor.RunMode.RUN_TO_POSITION);
        frontRightMotor.setMode(DcMotor.RunMode.RUN_TO_POSITION);
        backRightMotor.setMode(DcMotor.RunMode.RUN_TO_POSITION);

        frontLeftMotor.setPower(power);
        backLeftMotor.setPower(power);
        frontRightMotor.setPower(power);
        backRightMotor.setPower(power);

        while (opModeIsActive() &&
                frontLeftMotor.isBusy() &&
                frontRightMotor.isBusy() &&
                backLeftMotor.isBusy() &&
                backRightMotor.isBusy()) {}

        stopMotors();
    }

    // === DRIVE STRAIGHT ===
    public void driveForDistance(double inches, double power) {
        int ticks = (int) (inches * TICKS_PER_INCH);

        frontLeftMotor.setTargetPosition(frontLeftMotor.getCurrentPosition() + ticks);
        backLeftMotor.setTargetPosition(backLeftMotor.getCurrentPosition() + ticks);
        frontRightMotor.setTargetPosition(frontRightMotor.getCurrentPosition() + ticks);
        backRightMotor.setTargetPosition(backRightMotor.getCurrentPosition() + ticks);

        frontLeftMotor.setMode(DcMotor.RunMode.RUN_TO_POSITION);
        backLeftMotor.setMode(DcMotor.RunMode.RUN_TO_POSITION);
        frontRightMotor.setMode(DcMotor.RunMode.RUN_TO_POSITION);
        backRightMotor.setMode(DcMotor.RunMode.RUN_TO_POSITION);

        frontLeftMotor.setPower(power);
        backLeftMotor.setPower(power);
        frontRightMotor.setPower(power);
        backRightMotor.setPower(power);

        while (opModeIsActive() &&
                frontLeftMotor.isBusy() &&
                frontRightMotor.isBusy() &&
                backLeftMotor.isBusy() &&
                backRightMotor.isBusy()) {}

        stopMotors();
    }

    // === STRAFE ===
    public void strafeForDistance(double inches, double power, boolean strafeRight) {
        int ticks = (int) (inches * TICKS_PER_INCH);

        if (strafeRight) {
            frontLeftMotor.setTargetPosition(frontLeftMotor.getCurrentPosition() + ticks);
            backLeftMotor.setTargetPosition(backLeftMotor.getCurrentPosition() - ticks);
            frontRightMotor.setTargetPosition(frontRightMotor.getCurrentPosition() - ticks);
            backRightMotor.setTargetPosition(backRightMotor.getCurrentPosition() + ticks);
        } else {
            frontLeftMotor.setTargetPosition(frontLeftMotor.getCurrentPosition() - ticks);
            backLeftMotor.setTargetPosition(backLeftMotor.getCurrentPosition() + ticks);
            frontRightMotor.setTargetPosition(frontRightMotor.getCurrentPosition() + ticks);
            backRightMotor.setTargetPosition(backRightMotor.getCurrentPosition() - ticks);
        }

        frontLeftMotor.setMode(DcMotor.RunMode.RUN_TO_POSITION);
        backLeftMotor.setMode(DcMotor.RunMode.RUN_TO_POSITION);
        frontRightMotor.setMode(DcMotor.RunMode.RUN_TO_POSITION);
        backRightMotor.setMode(DcMotor.RunMode.RUN_TO_POSITION);

        frontLeftMotor.setPower(power);
        backLeftMotor.setPower(power);
        frontRightMotor.setPower(power);
        backRightMotor.setPower(power);

        while (opModeIsActive() &&
                frontLeftMotor.isBusy() &&
                frontRightMotor.isBusy() &&
                backLeftMotor.isBusy() &&
                backRightMotor.isBusy()) {}

        stopMotors();
    }

    // === STOP MOTORS ===
    private void stopMotors() {
        frontLeftMotor.setPower(0);
        frontRightMotor.setPower(0);
        backLeftMotor.setPower(0);
        backRightMotor.setPower(0);

        frontLeftMotor.setMode(DcMotor.RunMode.RUN_USING_ENCODER);
        frontRightMotor.setMode(DcMotor.RunMode.RUN_USING_ENCODER);
        backLeftMotor.setMode(DcMotor.RunMode.RUN_USING_ENCODER);
        backRightMotor.setMode(DcMotor.RunMode.RUN_USING_ENCODER);
    }
}

